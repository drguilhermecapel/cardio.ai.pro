"""
Contextual Response Generator for Non-ECG Images
Generates educational and helpful responses based on image classification.
"""

import logging
from typing import Any

from app.models.user import UserSession
from app.services.non_ecg_image_classifier import NonECGImageClassifier

logger = logging.getLogger(__name__)


class ContextualResponseGenerator:
    """Generate contextual, educational responses for non-ECG images."""

    def __init__(self) -> None:
        """Initialize the contextual response generator."""
        from app.services.adaptive_feedback_service import adaptive_feedback_service
        self.adaptive_feedback_service = adaptive_feedback_service
        self.classifier = NonECGImageClassifier()
        self.ecg_examples = self._load_ecg_examples()

    def generate_response(
        self,
        category: str,
        confidence: float,
        user_session: UserSession | None = None
    ) -> dict[str, Any]:
        """Generate contextual response based on image category and user history."""

        base_response = self._get_base_response(category, confidence)

        if user_session:
            base_response = self._personalize_response(base_response, user_session)

        base_response.update({
            'tips': base_response.get('tips', []),
            'ecg_visual_guide': self._generate_ecg_visual_guide(),
            'helpful_actions': self._get_helpful_actions(),
            'privacy_notice': "üîí Sua imagem n√£o foi armazenada por n√£o ser um ECG.",
            'learn_more_link': "Saiba mais sobre ECGs ‚Üí"
        })

        return base_response

    def _get_base_response(self, category: str, confidence: float) -> dict[str, Any]:
        """Get base response for specific category."""

        responses = {
            'x_ray': {
                'message': "Detectamos uma imagem de raio-X.",
                'explanation': "Raios-X s√£o exames importantes, mas analisamos especificamente eletrocardiogramas (ECGs).",
                'tips': [
                    "ECGs mostram a atividade el√©trica do cora√ß√£o, n√£o estruturas √≥sseas",
                    "Procure por um documento com ondas card√≠acas em papel milimetrado",
                    "ECGs t√™m m√∫ltiplas deriva√ß√µes (I, II, III, aVR, aVL, aVF, V1-V6)"
                ]
            },

            'medical_other': {
                'icon': 'üè•',
                'message': "Detectamos que voc√™ enviou um exame m√©dico, mas n√£o √© um ECG.",
                'explanation': "Este parece ser outro tipo de exame m√©dico. Nosso sistema √© especializado em an√°lise de eletrocardiogramas (ECG).",
                'tips': [
                    "Procure por papel milimetrado com ondas card√≠acas",
                    "ECGs mostram 12 deriva√ß√µes diferentes",
                    "Verifique se h√° informa√ß√µes do paciente no documento"
                ],
                'suggestion': "Se voc√™ precisa analisar este exame, recomendamos consultar um profissional especializado na √°rea.",
                'helpful_tip': "Um ECG tem um padr√£o caracter√≠stico de grade milimetrada com ondas card√≠acas.",
                'tone': 'professional_helpful'
            },

            'xray': {
                'icon': 'ü¶¥',
                'message': "Esta parece ser uma radiografia (raio-X).",
                'explanation': "Radiografias s√£o excelentes para visualizar ossos e estruturas internas, mas nosso sistema analisa especificamente eletrocardiogramas (ECG).",
                'tips': [
                    "ECGs s√£o gr√°ficos de ondas, n√£o imagens anat√¥micas",
                    "Procure por papel com grade milimetrada",
                    "ECGs mostram ritmo card√≠aco ao longo do tempo"
                ],
                'suggestion': "Para an√°lise de radiografias, consulte um radiologista ou m√©dico especializado.",
                'helpful_tip': "ECGs mostram a atividade el√©trica do cora√ß√£o, n√£o imagens anat√¥micas como raios-X.",
                'tone': 'educational'
            },

            'prescription': {
                'icon': 'üíä',
                'message': "Identificamos uma receita m√©dica.",
                'explanation': "Receitas s√£o importantes para o tratamento, mas nosso foco √© na an√°lise de eletrocardiogramas (ECG).",
                'suggestion': "Para d√∫vidas sobre medicamentos, consulte seu m√©dico ou farmac√™utico.",
                'helpful_tip': "ECGs s√£o exames que registram os batimentos card√≠acos em papel milimetrado.",
                'tone': 'friendly_professional'
            },

            'lab_results': {
                'icon': 'üß™',
                'message': "Estes parecem ser resultados de exames laboratoriais.",
                'explanation': "Exames de sangue e outros testes laboratoriais s√£o fundamentais para o diagn√≥stico, mas analisamos especificamente ECGs.",
                'suggestion': "Para interpreta√ß√£o de exames laboratoriais, consulte o m√©dico que os solicitou.",
                'helpful_tip': "ECGs s√£o diferentes dos exames de sangue - eles mostram o ritmo e a atividade el√©trica do cora√ß√£o.",
                'tone': 'informative'
            },

            'photo_person': {
                'icon': 'üì∏',
                'message': "Esta √© uma foto de pessoa.",
                'explanation': "Embora pessoas sejam importantes, nosso sistema analisa documentos m√©dicos espec√≠ficos: eletrocardiogramas (ECG).",
                'suggestion': "Para an√°lise de ECG, voc√™ precisa de um documento m√©dico com o registro dos batimentos card√≠acos.",
                'helpful_tip': "ECGs s√£o impressos em papel especial com grade milimetrada e mostram ondas card√≠acas.",
                'tone': 'friendly_light',
                'humor': "üì∑ Bela foto! Mas analisamos batimentos, n√£o sorrisos! üòä"
            },

            'screenshot': {
                'icon': 'üì±',
                'message': "Esta √© uma captura de tela.",
                'explanation': "Capturas de tela podem conter informa√ß√µes √∫teis, mas precisamos do documento ECG original para an√°lise precisa.",
                'suggestion': "Se voc√™ tem um ECG em formato digital, tente fazer upload do arquivo original ou uma foto clara do documento impresso.",
                'helpful_tip': "Para melhor an√°lise, use fotos diretas do ECG em papel ou arquivos digitais originais.",
                'tone': 'helpful_technical'
            },

            'nature': {
                'icon': 'üåø',
                'message': "Que bela paisagem!",
                'explanation': "A natureza √© relaxante e faz bem ao cora√ß√£o, mas nosso sistema analisa especificamente eletrocardiogramas m√©dicos.",
                'suggestion': "Para an√°lise card√≠aca, voc√™ precisar√° de um ECG realizado por um profissional de sa√∫de.",
                'helpful_tip': "ECGs capturam os 'ritmos da natureza' do seu cora√ß√£o em papel milimetrado.",
                'tone': 'friendly_light',
                'humor': "üå± A natureza √© √≥tima para o cora√ß√£o, mas precisamos ver os batimentos no papel! üíö"
            },

            'object': {
                'icon': 'üì¶',
                'message': "Identificamos um objeto na imagem.",
                'explanation': "Objetos diversos podem ser interessantes, mas nosso sistema √© especializado em an√°lise de eletrocardiogramas (ECG).",
                'suggestion': "Para an√°lise card√≠aca, voc√™ precisar√° de um documento ECG de um exame m√©dico.",
                'helpful_tip': "ECGs s√£o documentos m√©dicos espec√≠ficos com ondas que representam batimentos card√≠acos.",
                'tone': 'neutral_helpful'
            },

            'text_document': {
                'icon': 'üìÑ',
                'message': "Este √© um documento de texto.",
                'explanation': "Documentos de texto s√£o √∫teis para informa√ß√µes, mas analisamos especificamente eletrocardiogramas (ECG) m√©dicos.",
                'suggestion': "Se voc√™ tem um relat√≥rio m√©dico com ECG, procure pela parte que cont√©m as ondas card√≠acas em grade milimetrada.",
                'helpful_tip': "ECGs t√™m caracter√≠sticas visuais espec√≠ficas: grade milimetrada e ondas card√≠acas.",
                'tone': 'instructional'
            },

            'other_medical_device': {
                'icon': '‚öïÔ∏è',
                'message': "Detectamos sa√≠da de outro dispositivo m√©dico.",
                'explanation': "Existem muitos dispositivos m√©dicos importantes, mas nosso sistema √© otimizado especificamente para eletrocardiogramas (ECG).",
                'suggestion': "Se este dispositivo produz ECGs, procure pela sa√≠da que mostra ondas card√≠acas em papel milimetrado.",
                'helpful_tip': "ECGs t√™m formato padronizado com 12 deriva√ß√µes e grade milimetrada caracter√≠stica.",
                'tone': 'professional_specific'
            },

            'monitor_screen': {
                'icon': 'üñ•Ô∏è',
                'message': "Esta parece ser uma tela de monitor m√©dico.",
                'explanation': "Monitores m√©dicos mostram informa√ß√µes valiosas, mas para an√°lise detalhada precisamos do ECG impresso ou exportado.",
                'suggestion': "Tente obter uma impress√£o do ECG ou exporte os dados do monitor para an√°lise mais precisa.",
                'helpful_tip': "ECGs impressos oferecem melhor resolu√ß√£o e detalhes para an√°lise computacional.",
                'tone': 'technical_helpful'
            },

            'handwritten': {
                'icon': '‚úçÔ∏è',
                'message': "Identificamos anota√ß√µes manuscritas.",
                'explanation': "Anota√ß√µes m√©dicas s√£o importantes para o contexto, mas analisamos os tra√ßados eletr√¥nicos do ECG.",
                'suggestion': "Se h√° um ECG junto com essas anota√ß√µes, foque na parte com as ondas card√≠acas em papel milimetrado.",
                'helpful_tip': "ECGs s√£o tra√ßados eletr√¥nicos precisos, diferentes de anota√ß√µes manuais.",
                'tone': 'clarifying'
            },

            'food': {
                'icon': 'üçï',
                'message': "Hmm... delicioso!",
                'explanation': "Uma boa alimenta√ß√£o √© importante para a sa√∫de card√≠aca, mas analisamos eletrocardiogramas m√©dicos.",
                'tips': [
                    "ECGs s√£o documentos m√©dicos com ondas card√≠acas",
                    "Procure por papel milimetrado com tra√ßados",
                    "ECGs geralmente t√™m 12 deriva√ß√µes diferentes"
                ],
                'suggestion': "Para an√°lise card√≠aca, voc√™ precisar√° de um ECG realizado por um profissional de sa√∫de.",
                'helpful_tip': "ECGs mostram como seu cora√ß√£o 'digere' os impulsos el√©tricos! üòÑ",
                'tone': 'friendly_humorous',
                'humor': "üçΩÔ∏è Analisamos batimentos, n√£o receitas! Mas uma dieta saud√°vel faz bem ao cora√ß√£o! üí™"
            },

            'document': {
                'icon': 'üìã',
                'message': "Este √© um documento geral.",
                'explanation': "Documentos podem conter informa√ß√µes m√©dicas importantes, mas precisamos especificamente de eletrocardiogramas (ECG).",
                'suggestion': "Se este documento cont√©m um ECG, procure pela se√ß√£o com ondas card√≠acas em papel milimetrado.",
                'helpful_tip': "ECGs s√£o facilmente identific√°veis pela grade milimetrada e padr√µes de ondas card√≠acas.",
                'tone': 'instructional'
            },

            'unknown': {
                'icon': 'ü§î',
                'message': "N√£o conseguimos identificar claramente o conte√∫do desta imagem.",
                'explanation': "Para uma an√°lise precisa, nosso sistema precisa de eletrocardiogramas (ECG) claros e bem definidos.",
                'tips': [
                    "Verifique se a imagem est√° clara e bem iluminada",
                    "ECGs t√™m grade milimetrada caracter√≠stica",
                    "Procure por ondas card√≠acas no documento"
                ],
                'suggestion': "Tente tirar uma nova foto com boa ilumina√ß√£o de um documento ECG, ou verifique se o arquivo n√£o est√° corrompido.",
                'helpful_tip': "ECGs t√™m caracter√≠sticas visuais distintas que facilitam a identifica√ß√£o.",
                'tone': 'helpful_troubleshooting'
            }
        }

        response = responses.get(category, responses['unknown'])
        result: dict[str, Any] = response.copy() if isinstance(response, dict) else {}

        if category == 'food':
            result['humor_response'] = self.generate_humor_response(category)

        return result

    def _personalize_response(
        self,
        base_response: dict[str, Any],
        user_session: UserSession
    ) -> dict[str, Any]:
        """Personalize response based on user session history."""

        # Add adaptive suggestions
        result = dict(base_response)
        result['adaptive_suggestions'] = self.get_adaptive_suggestions(base_response.get('category', 'unknown'), user_session)

        result['learning_stage'] = getattr(user_session, 'learning_stage', 'beginner')

        result['encouragement'] = "Continue tentando! Estamos aqui para ajudar voc√™ a analisar ECGs corretamente."

        return result

    def _generate_ecg_visual_guide(self) -> dict[str, Any]:
        """Generate visual guide showing what ECGs look like."""

        return {
            'title': "Como identificar um ECG:",
            'characteristics': [
                {
                    'feature': "Grade milimetrada",
                    'description': "Fundo com pequenos quadrados formando uma grade",
                    'icon': "üìê"
                },
                {
                    'feature': "12 deriva√ß√µes",
                    'description': "Geralmente mostra 12 diferentes 'vis√µes' do cora√ß√£o (I, II, III, aVR, aVL, aVF, V1-V6)",
                    'icon': "üî¢"
                },
                {
                    'feature': "Ondas card√≠acas",
                    'description': "Padr√µes de ondas que representam os batimentos do cora√ß√£o",
                    'icon': "„Ä∞Ô∏è"
                },
                {
                    'feature': "Informa√ß√µes do paciente",
                    'description': "Nome, idade, data do exame, frequ√™ncia card√≠aca",
                    'icon': "üë§"
                },
                {
                    'feature': "Papel especial",
                    'description': "Geralmente em papel t√©rmico ou especial para ECG",
                    'icon': "üìÑ"
                }
            ],
            'example_description': "Um ECG t√≠pico parece com um gr√°fico de ondas em papel milimetrado, mostrando o ritmo card√≠aco ao longo do tempo.",
            'common_formats': [
                "Papel impresso (mais comum)",
                "Arquivo PDF de ECG",
                "Imagem digital de alta resolu√ß√£o",
                "Foto clara do documento original"
            ]
        }

    def _get_helpful_actions(self) -> list[dict[str, str]]:
        """Get list of helpful actions user can take."""

        return [
            {
                'action': "Tirar nova foto",
                'description': "Fotografe um ECG real com boa ilumina√ß√£o",
                'icon': "üì∑"
            },
            {
                'action': "Ver exemplos de ECG",
                'description': "Veja como um ECG deve parecer",
                'icon': "üëÅÔ∏è"
            },
            {
                'action': "Tutorial sobre ECGs",
                'description': "Aprenda mais sobre eletrocardiogramas",
                'icon': "üéì"
            },
            {
                'action': "Falar com suporte",
                'description': "Precisa de ajuda? Entre em contato",
                'icon': "üí¨"
            }
        ]

    def _load_ecg_examples(self) -> list[dict[str, Any]]:
        """Load ECG examples for educational purposes."""


        return [
            {
                'type': "Normal ECG",
                'description': "ECG com ritmo sinusal normal",
                'characteristics': ["Ondas P regulares", "Complexos QRS estreitos", "Frequ√™ncia 60-100 bpm"]
            },
            {
                'type': "12-lead ECG",
                'description': "ECG padr√£o com 12 deriva√ß√µes",
                'characteristics': ["12 diferentes vis√µes do cora√ß√£o", "Grade milimetrada", "Informa√ß√µes do paciente"]
            },
            {
                'type': "Rhythm Strip",
                'description': "Tira de ritmo cont√≠nua",
                'characteristics': ["Registro longo de uma deriva√ß√£o", "√ötil para an√°lise de arritmias"]
            }
        ]

    def generate_educational_content(self, category: str) -> dict[str, Any]:
        """Generate educational content specific to the detected category."""

        educational_content = {
            'medical_other': {
                'title': "Diferen√ßas entre ECG e outros exames m√©dicos",
                'description': "ECGs s√£o documentos m√©dicos especializados que diferem de outros exames",
                'content': [
                    "ECGs medem atividade el√©trica do cora√ß√£o",
                    "Outros exames podem medir diferentes aspectos da sa√∫de",
                    "Cada exame tem sua import√¢ncia espec√≠fica no diagn√≥stico"
                ],
                'comparison': "ECG vs. outros exames m√©dicos",
                'key_features': [
                    "Grade milimetrada caracter√≠stica",
                    "Ondas P, QRS e T vis√≠veis",
                    "M√∫ltiplas deriva√ß√µes (I, II, III, aVR, aVL, aVF, V1-V6)",
                    "Informa√ß√µes do paciente e configura√ß√µes do equipamento"
                ]
            },

            'xray': {
                'title': "ECG vs. Radiografia: Entenda a diferen√ßa",
                'description': "Radiografias e ECGs s√£o exames complementares com prop√≥sitos diferentes",
                'content': [
                    "Radiografias mostram estruturas anat√¥micas (ossos, √≥rg√£os)",
                    "ECGs mostram atividade el√©trica do cora√ß√£o",
                    "Ambos s√£o importantes para diagn√≥stico card√≠aco completo"
                ],
                'comparison': "Imagem anat√¥mica vs. atividade el√©trica",
                'key_features': [
                    "Grade milimetrada caracter√≠stica",
                    "Ondas P, QRS e T vis√≠veis",
                    "M√∫ltiplas deriva√ß√µes (I, II, III, aVR, aVL, aVF, V1-V6)",
                    "Informa√ß√µes do paciente e configura√ß√µes do equipamento"
                ]
            },

            'photo_person': {
                'title': "Por que precisamos de documentos m√©dicos?",
                'description': "Fotos pessoais n√£o fornecem dados m√©dicos necess√°rios para an√°lise",
                'content': [
                    "Fotos de pessoas n√£o cont√™m dados m√©dicos mensur√°veis",
                    "ECGs fornecem dados precisos sobre fun√ß√£o card√≠aca",
                    "An√°lise m√©dica requer documenta√ß√£o espec√≠fica"
                ],
                'comparison': "Foto pessoal vs. documento m√©dico",
                'key_features': [
                    "Grade milimetrada caracter√≠stica",
                    "Ondas P, QRS e T vis√≠veis",
                    "M√∫ltiplas deriva√ß√µes (I, II, III, aVR, aVL, aVF, V1-V6)",
                    "Informa√ß√µes do paciente e configura√ß√µes do equipamento"
                ]
            }
        }

        return educational_content.get(category, {
            'title': "Sobre eletrocardiogramas (ECG)",
            'description': "ECGs s√£o documentos m√©dicos especializados para an√°lise card√≠aca",
            'content': [
                "ECGs registram a atividade el√©trica do cora√ß√£o",
                "S√£o fundamentais para diagn√≥stico de problemas card√≠acos",
                "Requerem interpreta√ß√£o por profissionais qualificados"
            ],
            'comparison': "Documento m√©dico especializado",
            'key_features': [
                "Grade milimetrada caracter√≠stica",
                "Ondas P, QRS e T vis√≠veis",
                "M√∫ltiplas deriva√ß√µes (I, II, III, aVR, aVL, aVF, V1-V6)",
                "Informa√ß√µes do paciente e configura√ß√µes do equipamento"
            ]
        })

    def get_adaptive_suggestions(
        self,
        category: str,
        user_session: Any | None = None
    ) -> list[str]:
        """Get adaptive suggestions based on user's upload history."""

        user_history = []
        if user_session and hasattr(user_session, 'category_history'):
            user_history = user_session.category_history

        suggestions = []

        if user_history and hasattr(user_history, 'count') and user_history.count('photo_person') > 2:
            suggestions.append("Parece que voc√™ est√° enviando fotos pessoais. Para an√°lise card√≠aca, precisamos de documentos ECG m√©dicos.")

        medical_categories = ['medical_other', 'xray', 'prescription', 'lab_results']
        if user_history and hasattr(user_history, '__contains__') and any(cat in user_history for cat in medical_categories):
            suggestions.append("Vemos que voc√™ tem documentos m√©dicos. Procure especificamente por um ECG (eletrocardiograma) com ondas card√≠acas.")

        if user_history and hasattr(user_history, '__contains__') and 'screenshot' in user_history:
            suggestions.append("Para melhor an√°lise, use o arquivo original do ECG ou uma foto direta do documento impresso.")

        if not suggestions:
            suggestions.append("Dica: ECGs s√£o facilmente identific√°veis pela grade milimetrada e ondas card√≠acas caracter√≠sticas.")

        return suggestions

    def get_base_response_categories(self) -> dict[str, Any]:
        """Get list of supported response categories."""
        return {
            'categories': [
                'x_ray', 'medical_other', 'prescription', 'lab_results',
                'medical_device', 'monitor_screen', 'document', 'text_document',
                'handwritten', 'photo_person', 'nature', 'object', 'food', 'screenshot'
            ],
            'total_count': 14
        }

    def generate_humor_response(self, category: str) -> str | None:
        """Generate light humor when appropriate."""

        humor_responses = {
            'food': [
                "üçé Uma ma√ß√£ por dia mant√©m o m√©dico longe, mas um ECG nos mant√©m pr√≥ximos! üòÑ",
                "ü•ó Comida saud√°vel faz bem ao cora√ß√£o, ECGs nos mostram como ele est√°! üíö",
                "üçï Pizza √© boa para a alma, ECG √© bom para o cora√ß√£o! üòä"
            ],

            'nature': [
                "üå≥ A natureza acalma o cora√ß√£o, ECGs nos mostram seu ritmo! üéµ",
                "üå∏ Flores s√£o belas, mas as ondas do ECG tamb√©m t√™m sua beleza! üíñ",
                "üèîÔ∏è Montanhas t√™m picos, ECGs tamb√©m! Mas os do cora√ß√£o s√£o mais importantes! ‚õ∞Ô∏è"
            ],

            'photo_person': [
                "üì∏ Bela foto! Mas preferimos ver os 'retratos' que o cora√ß√£o desenha no ECG! üíù",
                "üòä Sorrisos fazem bem ao cora√ß√£o, ECGs nos mostram como ele responde! üíì",
                "üë• Pessoas s√£o especiais, mas os batimentos card√≠acos s√£o √∫nicos! üíó"
            ]
        }

        responses = humor_responses.get(category, [])
        if responses:
            import random
            return random.choice(responses)

        return None


contextual_response_generator = ContextualResponseGenerator()
